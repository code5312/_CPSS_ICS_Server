<!-- index.html -->
{% extends 'base.html' %}
{% block title %}ëŒ€ì‹œë³´ë“œ | ICS HMI{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h2 class="mb-3">ICS HMI - ì›ì‹¬ë¶„ë¦¬ê¸° ì œì–´</h2>
<p>ğŸ”„ í˜„ì¬ íšŒì „ìˆ˜: <strong><span id="rpm-display">{{ rpm }}</span> RPM</strong></p>
<canvas id="rpmChart" height="120"></canvas>
<canvas id="tempChart" height="120"></canvas>
<canvas id="pressureChart" height="120"></canvas>
<p id="alert-box" class="mt-3 fw-bold text-danger"></p>

<!-- âœ… FLAG ì¶œë ¥ ì˜ì—­ -->
{% if flag %}
<div class="alert alert-success mt-3">
  ğŸ‰ <strong>FLAG íšë“:</strong> {{ flag }}
</div>
{% endif %}

{% if role == 'admin' %}
<form method="POST" action="/set_rpm" class="mt-4">
  <label for="rpm">ìƒˆ íšŒì „ìˆ˜ ì„¤ì • (RPM):</label>
  <input type="number" name="rpm" id="rpm" required min="0" class="form-control">
  <button type="submit" class="btn btn-primary mt-2">ì ìš©</button>
</form>
{% else %}
<p class="text-muted">ê²ŒìŠ¤íŠ¸ëŠ” íšŒì „ìˆ˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<hr>

{% if role == 'admin' %}
<h4>ğŸ›  ìƒíƒœ ì„¤ì •</h4>
<form method="POST" action="/set_status">
  <label>RPM:</label>
  <input type="number" name="rpm" value="{{ rpm }}" min="0" max="10000" class="form-control">
  <label>í˜„ì¬ ì˜¨ë„(Â°C):</label>
  <input type="number" step="0.1" name="temperature" value="{{ temperature }}" class="form-control">
  <label>í˜„ì¬ ì••ë ¥(bar):</label>
  <input type="number" step="0.1" name="pressure" value="{{ pressure }}" class="form-control">
  <button type="submit" class="btn btn-warning mt-2">ì„¤ì • ì ìš©</button>
</form>
{% endif %}

{% if success %}<p class="text-success">{{ success }}</p>{% endif %}
{% if error %}<p class="text-danger">{{ error }}</p>{% endif %}

{% if role == 'admin' %}
<hr>
<h4>ğŸ”§ ë¡œê·¸ì¸ ì‹¤íŒ¨ ê¸°ë¡ ì´ˆê¸°í™”</h4>
<form method="POST" action="/admin/reset_user">
  <label>ì‚¬ìš©ì ID:</label>
  <input type="text" name="target_user" class="form-control" required>
  <button type="submit" class="btn btn-danger mt-2">ê¸°ë¡ ì´ˆê¸°í™”</button>
</form>
{% endif %}

<form method="GET" action="/logout" class="mt-3">
  <button type="submit" class="btn btn-outline-secondary">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
</form>
<a href="{{ url_for('main.board') }}" class="btn btn-link mt-2">ğŸ“ ì†Œí†µ ê²Œì‹œíŒ ë°”ë¡œê°€ê¸°</a>

<hr>

<h3> ì‚¬ìš©ì ê³„ì • ì •ë³´ ì¡°íšŒ </h3>
<form method = "GET" action="/search_user">
  <input type="text" name="q" placeholder="ê²€ìƒ‰í•  ì‚¬ìš©ì ì´ë¦„ ì…ë ¥" required>
  <button type="submit" ê²€ìƒ‰></button>
</form>
<hr>
<h3> ì›¹ì—ì„œ ì‚¬ì§„ ê°€ì ¸ì˜¤ê¸° </h3>
<a href="{{ url_for('main.soap') }}" class="btn btn-link mt-2">ğŸ“ ë¶ˆëŸ¬ì˜¤ê¸°</a>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
const rpmChart = createChart('rpmChart', 'RPM', 'blue');
const tempChart = createChart('tempChart', 'Temperature (Â°C)', 'orange');
const pressureChart = createChart('pressureChart', 'Pressure (bar)', 'green');

function createChart(id, label, color) {
  const ctx = document.getElementById(id).getContext('2d');
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: label,
        data: [],
        borderColor: color,
        borderWidth: 2
      }]
    },
    options: {
      animation: false,
      scales: {
        x: { title: { display: true, text: 'Time' } },
        y: { beginAtZero: true }
      }
    }
  });
}

function updateChart(chart, value, label) {
  if (chart.data.labels.length > 20) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(value);
  chart.update();
}

function fetchStatus() {
  fetch('/status')
    .then(r => r.json())
    .then(data => {
      const now = new Date().toLocaleTimeString();
      updateChart(rpmChart, data.rpm, now);
      updateChart(tempChart, data.temperature, now);
      updateChart(pressureChart, data.pressure, now);

      const a = document.getElementById('alert-box');
      if (data.rpm >= (data.thresholds?.rpm ?? 3000)) {
        a.textContent = `âš ï¸ RPM ê²½ê³ ! í˜„ì¬: ${data.rpm}`;
      } else if (data.temperature >= (data.thresholds?.temperature ?? 80)) {
        a.textContent = `ğŸŒ¡ï¸ ì˜¨ë„ ê²½ê³ ! í˜„ì¬: ${data.temperature}Â°C`;
      } else if (data.pressure >= (data.thresholds?.pressure ?? 5.0)) {
        a.textContent = `ğŸ’¨ ì••ë ¥ ê²½ê³ ! í˜„ì¬: ${data.pressure} bar`;
      } else {
        a.textContent = '';
      }
    });
}

setInterval(fetchStatus, 1000);
</script>
{% endblock %}
