<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ICS HMI Simulator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>ICS HMI - ì›ì‹¬ë¶„ë¦¬ê¸° ì œì–´</h1>
    <p>ğŸ”„ í˜„ì¬ íšŒì „ìˆ˜: <strong><span id="rpm-display">{{ rpm }}</span> RPM</strong></p>

    <!-- ì‹¤ì‹œê°„ ê·¸ë˜í”„ -->
    <canvas id="rpmChart" width="600" height="200"></canvas>
    <canvas id="tempChart" width="600" height="200"></canvas>
    <canvas id="pressureChart" width="600" height="200"></canvas>

    <!-- ê²½ê³  ì•Œë¦¼ -->
    <p id="alert-box" style="color: red; font-weight: bold;"></p>

    <!-- ì‹¤ì‹œê°„ ìƒíƒœ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        const rpmMaxThreshold = 3000;

        function createChart(id, label, color) {
            const ctx = document.getElementById(id).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: color,
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    animation: false,
                    scales: {
                        x: { title: { display: true, text: 'Time' }},
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        const rpmChart = createChart('rpmChart', 'RPM', 'blue');
        const tempChart = createChart('tempChart', 'Temperature (Â°C)', 'orange');
        const pressureChart = createChart('pressureChart', 'Pressure (bar)', 'green');

        function updateChart(chart, value, label) {
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(value);
            chart.update();
        }

        function fetchStatus() {
        fetch('/status')
            .then(response => response.json())
            .then(data => {
                const now = new Date().toLocaleTimeString();

                updateChart(rpmChart, data.rpm, now);
                updateChart(tempChart, data.temperature, now);
                updateChart(pressureChart, data.pressure, now);

                // ë™ì ìœ¼ë¡œ ì „ë‹¬ëœ ì„ê³„ê°’
                const rpmThreshold = data.thresholds?.rpm ?? 3000;
                const tempThreshold = data.thresholds?.temperature ?? 80;
                const pressureThreshold = data.thresholds?.pressure ?? 5.0;

                const alertBox = document.getElementById('alert-box');
                if (data.rpm >= rpmThreshold) {
                    alertBox.textContent = `âš ï¸ RPM ê²½ê³ ! í˜„ì¬ RPM: ${data.rpm} (ì„ê³„ê°’: ${rpmThreshold})`;
                } else if (data.temperature >= tempThreshold) {
                    alertBox.textContent = `ğŸŒ¡ï¸ ì˜¨ë„ ê²½ê³ ! í˜„ì¬: ${data.temperature}Â°C (ì„ê³„ê°’: ${tempThreshold})`;
                } else if (data.pressure >= pressureThreshold) {
                    alertBox.textContent = `ğŸ’¨ ì••ë ¥ ê²½ê³ ! í˜„ì¬: ${data.pressure} bar (ì„ê³„ê°’: ${pressureThreshold})`;
                } else {
                    alertBox.textContent = '';
                }
            });
    }

    setInterval(fetchStatus, 1000);
</script>

    <!-- RPM ì œì–´ -->
    {% if role == 'admin' %}
        <form method="POST" action="/set_rpm">
            <label for="rpm">ìƒˆ íšŒì „ìˆ˜ ì„¤ì • (RPM):</label>
            <input type="number" name="rpm" id="rpm" required min="0">
            <button type="submit">ì ìš©</button>
        </form>
    {% else %}
        <p style="color: gray;">ê²ŒìŠ¤íŠ¸ëŠ” íšŒì „ìˆ˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
<hr>
{% if role == 'admin' %}
<h3>ğŸ›  ìƒíƒœ ì„¤ì •</h3>
<form method="POST" action="/set_status">
    <label for="rpm">RPM ì„¤ì •:</label>
    <input type="number" name="rpm" value="{{ rpm }}" min="0" max="10000"><br>

    <label for="temperature">í˜„ì¬ ì˜¨ë„(Â°C):</label>
    <input type="number" step="0.1" name="temperature" value="{{ temperature }}"><br>

    <label for="pressure">í˜„ì¬ ì••ë ¥(bar):</label>
    <input type="number" step="0.1" name="pressure" value="{{ pressure }}"><br>

    <button type="submit">ì„¤ì • ì ìš©</button>
</form>
{% endif %}

{% if success %}
<p style="color: green;">{{ success }}</p>
{% endif %}
{% if error %}
<p style="color: red;">{{ error }}</p>
{% endif %}

    <!-- ê´€ë¦¬ì ê¸°ëŠ¥: ë¡œê·¸ì¸ ì‹¤íŒ¨ ì´ˆê¸°í™” -->
    {% if role == 'admin' %}
        <hr>
        <h3>ğŸ”§ ë¡œê·¸ì¸ ì‹¤íŒ¨ ê¸°ë¡ ì´ˆê¸°í™”</h3>
        <form method="POST" action="/admin/reset_user">
            <label for="target_user">ì‚¬ìš©ì ID:</label>
            <input type="text" name="target_user" id="target_user" required>
            <button type="submit">ê¸°ë¡ ì´ˆê¸°í™”</button>
        </form>
    {% endif %}

    <!-- ë¡œê·¸ì•„ì›ƒ -->
    <form method="GET" action="/logout">
        <button type="submit">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </form>

    <a href="{{ url_for('main.board') }}">ğŸ“ ì†Œí†µ ê²Œì‹œíŒ ë°”ë¡œê°€ê¸°</a>
    <hr>

    <hr>
        <h3>ì‚¬ìš©ì ê²€ìƒ‰</h3>
        <form method="GET" action="{{ url_for('main.search_user') }}">
            <input type="text" name="q" placeholder="ê²€ìƒ‰í•  ì‚¬ìš©ì ì´ë¦„ ì…ë ¥" required>
            <button type="submit">ê²€ìƒ‰</button>
    </form>

    {% if query %}
        <h4>'{{ query }}' ê²€ìƒ‰ ê²°ê³¼:</h4>
        {% if users %}
            <ul>
                {% for user in users %}
                    <li>
                        <b>ID:</b> {{ user.id }},
                        <b>Username:</b> {{ user.username }},
                        <b>Password:</b> {{ user.password }},
                        <b>Role:</b> {{ user.role }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>â— ì¼ì¹˜í•˜ëŠ” ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    {% endif %}

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
